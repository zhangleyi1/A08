Index: frameworks/av/media/libstagefright/SampleTable.cpp
===================================================================
--- frameworks/av/media/libstagefright/SampleTable.cpp	(revision 175234)
+++ frameworks/av/media/libstagefright/SampleTable.cpp	(revision 175235)
@@ -567,6 +567,10 @@
     }
 
     for (size_t i = 0; i < numSyncSamples; ++i) {
+        if (mSyncSamples[i] == 0) {
+            ALOGE("b/32423862, unexpected zero value in stss");
+            continue;
+        }
         mSyncSamples[i] = ntohl(mSyncSamples[i]) - 1;
     }
 
Index: system/core/libziparchive/zip_archive.cc
===================================================================
--- system/core/libziparchive/zip_archive.cc	(revision 175234)
+++ system/core/libziparchive/zip_archive.cc	(revision 175235)
@@ -386,15 +386,18 @@
   const uint8_t* const cd_end = cd_ptr + cd_length;
   const uint8_t* ptr = cd_ptr;
   for (uint16_t i = 0; i < num_entries; i++) {
+    if (ptr > cd_end - sizeof(CentralDirectoryRecord)) {
+      ALOGW("Zip: ran off the end (at %" PRIu16 ")", i);
+#if defined(__ANDROID__)
+      android_errorWriteLog(0x534e4554, "36392138");
+#endif
+      return -1;
+    }
     const CentralDirectoryRecord* cdr =
         reinterpret_cast<const CentralDirectoryRecord*>(ptr);
     if (cdr->record_signature != CentralDirectoryRecord::kSignature) {
       ALOGW("Zip: missed a central dir sig (at %" PRIu16 ")", i);
-      return -1;
-    }
 
-    if (ptr + sizeof(CentralDirectoryRecord) > cd_end) {
-      ALOGW("Zip: ran off the end (at %" PRIu16 ")", i);
       return -1;
     }
 
Index: system/bt/stack/btm/btm_ble_gap.c
===================================================================
--- system/bt/stack/btm/btm_ble_gap.c	(revision 175234)
+++ system/bt/stack/btm/btm_ble_gap.c	(revision 175235)
@@ -28,6 +28,7 @@
 #include <stdio.h>
 #include <stddef.h>
 
+#include <log/log.h>
 #include "bt_types.h"
 #include "bt_utils.h"
 #include "btm_ble_api.h"
@@ -2285,7 +2286,7 @@
 ** Returns          void
 **
 *******************************************************************************/
-void btm_ble_cache_adv_data(tBTM_INQ_RESULTS *p_cur, UINT8 data_len, UINT8 *p, UINT8 evt_type)
+BOOLEAN btm_ble_cache_adv_data(tBTM_INQ_RESULTS *p_cur, UINT8 data_len, UINT8 *p, UINT8 evt_type)
 {
     tBTM_BLE_INQ_CB     *p_le_inq_cb = &btm_cb.ble_ctr_cb.inq_var;
     UINT8 *p_cache;
@@ -2305,8 +2306,14 @@
         STREAM_TO_UINT8(length, p);
         while ( length && ((p_le_inq_cb->adv_len + length + 1) <= BTM_BLE_CACHE_ADV_DATA_MAX))
         {
+            if ((length + 1) > data_len) {
+                BTM_TRACE_ERROR("BTM - got incorrect LE advertising data");
+                android_errorWriteLog(0x534e4554, "33899337");
+                return FALSE;
+            }
             /* copy from the length byte & data into cache */
             memcpy(p_cache, p-1, length+1);
+            data_len -= length + 1;
             /* advance the cache pointer past data */
             p_cache += length+1;
             /* increment cache length */
@@ -2316,6 +2323,7 @@
             STREAM_TO_UINT8(length, p);
         }
     }
+    return TRUE;
 
     /* parse service UUID from adv packet and save it in inq db eir_uuid */
     /* TODO */
@@ -2540,7 +2548,9 @@
         BTM_TRACE_WARNING("EIR data too long %d. discard", data_len);
         return FALSE;
     }
-    btm_ble_cache_adv_data(p_cur, data_len, p, evt_type);
+    if (!btm_ble_cache_adv_data(p_cur, data_len, p, evt_type)) {
+        return FALSE;
+    }
 
     p1 = (p + data_len);
     STREAM_TO_UINT8 (rssi, p1);
Index: packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppHandoverReceiver.java
===================================================================
--- packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppHandoverReceiver.java	(revision 175234)
+++ packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppHandoverReceiver.java	(revision 175235)
@@ -50,7 +50,7 @@
                     // Save type/stream, will be used when adding transfer
                     // session to DB.
                     BluetoothOppManager.getInstance(context).saveSendingFileInfo(type,
-                            stream.toString(), true);
+                            stream.toString(), true /* isHandover */, true /* fromExternal */);
                 } else {
                     if (D) Log.d(TAG, "No mimeType or stream attached to handover request");
                 }
@@ -60,7 +60,7 @@
                 uris = intent.getParcelableArrayListExtra(Intent.EXTRA_STREAM);
                 if (mimeType != null && uris != null) {
                     BluetoothOppManager.getInstance(context).saveSendingFileInfo(mimeType,
-                            uris, true);
+                            uris, true/* isHandover */, true /* fromExternal */);
                 } else {
                     if (D) Log.d(TAG, "No mimeType or stream attached to handover request");
                     return;
Index: packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppUtility.java
===================================================================
--- packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppUtility.java	(revision 175234)
+++ packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppUtility.java	(revision 175235)
@@ -39,6 +39,7 @@
 import android.bluetooth.BluetoothAdapter;
 import android.bluetooth.BluetoothDevice;
 import android.net.Uri;
+import android.content.ContentResolver;
 import android.content.ContentValues;
 import android.content.Context;
 import android.content.ActivityNotFoundException;
@@ -46,6 +47,7 @@
 import android.content.pm.PackageManager;
 import android.content.pm.ResolveInfo;
 import android.database.Cursor;
+import android.os.EnvironmentEx;
 import android.util.Log;
 import android.os.Handler;
 import android.os.Message;
@@ -76,6 +78,10 @@
     private static final int OBEX_TIMEOUT_DELAY = 120000;
     private static boolean bIsSessionTimerSwitchOn = SystemProperties.getBoolean("persist.bt.autodisconnect", true);
     //<-- Add for Add for Bluetooth Opp auto disconnect Feature END
+	
+	public static boolean isBluetoothShareUri(Uri uri) {
+        return uri.toString().startsWith(BluetoothShare.CONTENT_URI.toString());
+    }
 
     public static BluetoothOppTransferInfo queryRecord(Context context, Uri uri) {
         BluetoothOppTransferInfo info = new BluetoothOppTransferInfo();
@@ -187,6 +193,11 @@
             return;
         }
 
+		if (!isBluetoothShareUri(uri)) {
+            Log.e(TAG, "Trying to open a file that wasn't transfered over Bluetooth");
+            return;
+        }
+
         File f = new File(fileName);
         if (!f.exists()) {
             Intent in = new Intent(context, BluetoothOppBtErrorActivity.class);
@@ -217,17 +228,8 @@
                 .queryIntentActivities(activityIntent,
                         PackageManager.MATCH_DEFAULT_ONLY);
 
-            // Grant permissions for any app that can handle a file to access it
-            for (ResolveInfo resolveInfo : resInfoList) {
-                String packageName = resolveInfo.activityInfo.packageName;
-                context.grantUriPermission(packageName, path,
-                        Intent.FLAG_GRANT_WRITE_URI_PERMISSION |
-                        Intent.FLAG_GRANT_READ_URI_PERMISSION);
-            }
-
             activityIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
-            activityIntent.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
-            activityIntent.setFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
+            activityIntent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
 
             try {
                 if (V) Log.d(TAG, "ACTION_VIEW intent sent out: " + path + " / " + mimetype);
@@ -331,7 +333,11 @@
     public static void retryTransfer(Context context, BluetoothOppTransferInfo transInfo) {
         BluetoothDevice bluetoothDevice = BluetoothAdapter.getDefaultAdapter().getRemoteDevice(transInfo.mDestAddr);
         BluetoothOppManager oppManager = BluetoothOppManager.getInstance(context);
-        oppManager.saveSendingFileInfo(transInfo.mFileType, transInfo.mFileUri, transInfo.mHandoverInitiated);
+        if ("file:///data/user/0/com.android.bluetooth/files/bluetooth_content_share.html".equals(transInfo.mFileUri)) {
+            oppManager.saveSendingFileInfo(transInfo.mFileType, transInfo.mFileUri, transInfo.mHandoverInitiated, false);
+        } else {
+            oppManager.saveSendingFileInfo(transInfo.mFileType, transInfo.mFileUri, transInfo.mHandoverInitiated, true);
+        }
         oppManager.startTransfer(bluetoothDevice);
     }
 
@@ -402,4 +408,40 @@
             }
         }
     }
+	 /**
+     * Checks if the URI is in Environment.getExternalStorageDirectory() as it
+     * is the only directory that is possibly readable by both the sender and
+     * the Bluetooth process.
+     */
+    static boolean isInExternalStorageDir(Uri uri) {
+        if (!ContentResolver.SCHEME_FILE.equals(uri.getScheme())) {
+            Log.e(TAG, "Not a file URI: " + uri);
+            return false;
+        }
+        final File file = new File(uri.getCanonicalUri().getPath());
+        return (isSameOrSubDirectory(EnvironmentEx.getInternalStoragePath(), file)
+                || isSameOrSubDirectory(EnvironmentEx.getExternalStoragePath(), file));
+    }
+
+    /**
+     * Checks, whether the child directory is the same as, or a sub-directory of the base
+     * directory. Neither base nor child should be null.
+     */
+    static boolean isSameOrSubDirectory(File base, File child) {
+        try {
+            base = base.getCanonicalFile();
+            child = child.getCanonicalFile();
+            File parentFile = child;
+            while (parentFile != null) {
+                if (base.equals(parentFile)) {
+                    return true;
+                }
+                parentFile = parentFile.getParentFile();
+            }
+            return false;
+        } catch (IOException ex) {
+            Log.e(TAG, "Error while accessing file", ex);
+            return false;
+        }
+    }
 }
Index: packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppSendFileInfo.java
===================================================================
--- packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppSendFileInfo.java	(revision 175234)
+++ packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppSendFileInfo.java	(revision 175235)
@@ -41,6 +41,7 @@
 import android.net.Uri;
 import android.provider.MediaStore;
 import android.provider.OpenableColumns;
+import android.util.EventLog;
 import android.util.Log;
 
 import java.io.File;
@@ -100,7 +101,7 @@
     }
 
     public static BluetoothOppSendFileInfo generateFileInfo(Context context, Uri uri,
-            String type) {
+            String type, boolean fromExternal) {
         ContentResolver contentResolver = context.getContentResolver();
         String scheme = uri.getScheme();
         String fileName = null;
@@ -157,6 +158,15 @@
                 }
             }
         } else if ("file".equals(scheme)) {
+			if (uri.getPath() == null) {
+                Log.e(TAG, "Invalid URI path: " + uri);
+                return SEND_FILE_INFO_ERROR;
+            }
+            if (fromExternal && !BluetoothOppUtility.isInExternalStorageDir(uri)) {
+                EventLog.writeEvent(0x534e4554, "35310991", -1, uri.getPath());
+                Log.e(TAG, "File based URI not in Environment.getExternalStorageDirectory() is not allowed.");
+                return SEND_FILE_INFO_ERROR;
+            }
             fileName = uri.getLastPathSegment();
             contentType = type;
             File f = new File(uri.getPath());
Index: packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppManager.java
===================================================================
--- packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppManager.java	(revision 175234)
+++ packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppManager.java	(revision 175235)
@@ -256,7 +256,7 @@
             mUriOfSendingFile = uriString;
             Uri uri = Uri.parse(uriString);
             BluetoothOppUtility.putSendFileInfo(uri, BluetoothOppSendFileInfo
-                    .generateFileInfo(mContext, uri, mimeType));
+                    .generateFileInfo(mContext, uri, mimeType, fromExternal));
             storeApplicationData();
             if (uri != null && uri.getAuthority().equals("com.android.email.attachmentprovider")) {
                 isEmailUri = true;
@@ -264,7 +264,7 @@
         }
     }
 
-    public void saveSendingFileInfo(String mimeType, ArrayList<Uri> uris, boolean isHandover) {
+    public void saveSendingFileInfo(String mimeType, ArrayList<Uri> uris, boolean isHandover, boolean fromExternal) {
         synchronized (BluetoothOppManager.this) {
             mMultipleFlag = true;
             mMimeTypeOfSendingFiles = mimeType;
@@ -272,7 +272,7 @@
             mUrisOfSendingFiles.clear();
             for (Uri uri : uris) {
                 BluetoothOppUtility.putSendFileInfo(uri, BluetoothOppSendFileInfo
-                        .generateFileInfo(mContext, uri, mimeType));
+                        .generateFileInfo(mContext, uri, mimeType, fromExternal));
                 mUrisOfSendingFiles.add(uri);
                 if (uri != null && uri.getAuthority().equals("com.android.email.attachmentprovider")) {
                     isEmailUri = true;
Index: packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppLauncherActivity.java
===================================================================
--- packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppLauncherActivity.java	(revision 175234)
+++ packages/apps/Bluetooth/src/com/android/bluetooth/opp/BluetoothOppLauncherActivity.java	(revision 175235)
@@ -117,7 +117,8 @@
                     Thread t = new Thread(new Runnable() {
                         public void run() {
                             BluetoothOppManager.getInstance(BluetoothOppLauncherActivity.this)
-                                .saveSendingFileInfo(type,stream.toString(), false);
+                                .saveSendingFileInfo(type,stream.toString(), 
+								false /* isHandover */, true /* fromExternal */);
                             //Done getting file info..Launch device picker and finish this activity
                             launchDevicePicker();
                             //finish();
@@ -133,7 +134,8 @@
                         Thread t = new Thread(new Runnable() {
                             public void run() {
                                 BluetoothOppManager.getInstance(BluetoothOppLauncherActivity.this)
-                                    .saveSendingFileInfo(type,fileUri.toString(), false);
+                                    .saveSendingFileInfo(type,fileUri.toString(), 
+									false /* isHandover */, false /* fromExternal */);
                                 //Done getting file info..Launch device picker
                                 //and finish this activity
                                 launchDevicePicker();
@@ -161,7 +163,8 @@
                     Thread t = new Thread(new Runnable() {
                         public void run() {
                             BluetoothOppManager.getInstance(BluetoothOppLauncherActivity.this)
-                                .saveSendingFileInfo(mimeType,uris, false);
+                                .saveSendingFileInfo(mimeType,uris, 
+								 false /* isHandover */, true /* fromExternal */);
                             //Done getting file info..Launch device picker
                             //and finish this activity
                             launchDevicePicker();
Index: external/libxml2/uri.c
===================================================================
--- external/libxml2/uri.c	(revision 175234)
+++ external/libxml2/uri.c	(revision 175235)
@@ -12,6 +12,7 @@
 #include "libxml.h"
 
 #include <string.h>
+#include <limits.h>
 
 #include <libxml/xmlmemory.h>
 #include <libxml/uri.h>
Index: external/libxml2/xpath.c
===================================================================
--- external/libxml2/xpath.c	(revision 175234)
+++ external/libxml2/xpath.c	(revision 175235)
@@ -4368,7 +4368,7 @@
     }
     memset(ret, 0 , (size_t) sizeof(xmlXPathObject));
     ret->type = XPATH_XSLT_TREE;
-    ret->boolval = 1;
+    ret->boolval = 0;
     ret->user = (void *) val;
     ret->nodesetval = xmlXPathNodeSetCreate(val);
 #ifdef XP_DEBUG_OBJ_USAGE
@@ -10698,6 +10698,11 @@
 				"PathExpr: Type search\n");
 #endif
 			lc = 1;
+#ifdef LIBXML_XPTR_ENABLED
+                    } else if (ctxt->xptr &&
+                               xmlStrEqual(name, BAD_CAST "range-to")) {
+                        lc = 1;
+#endif			
 		    } else {
 #ifdef DEBUG_STEP
 		        xmlGenericError(xmlGenericErrorContext,
Index: external/libxml2/parser.c
===================================================================
--- external/libxml2/parser.c	(revision 175234)
+++ external/libxml2/parser.c	(revision 175235)
@@ -3398,8 +3398,15 @@
         xmlFatalErr(ctxt, XML_ERR_NAME_TOO_LONG, "Name");
         return(NULL);
     }
-    if ((*ctxt->input->cur == '\n') && (ctxt->input->cur[-1] == '\r'))
+    if (ctxt->input->cur > ctxt->input->base &&(*ctxt->input->cur == '\n') && (ctxt->input->cur[-1] == '\r')){
+		if (ctxt->input->base > ctxt->input->cur - (len + 1)) {
+            return(NULL);
+		}
         return(xmlDictLookup(ctxt->dict, ctxt->input->cur - (len + 1), len));
+	}	
+    if (ctxt->input->base > ctxt->input->cur - len) {
+        return(NULL);
+    }
     return(xmlDictLookup(ctxt->dict, ctxt->input->cur - len, len));
 }
 
@@ -8095,6 +8102,14 @@
 	    if (xmlPushInput(ctxt, input) < 0)
 		return;
 	} else {
+		if ((entity->etype == XML_EXTERNAL_PARAMETER_ENTITY) &&
+	        ((ctxt->options & XML_PARSE_NOENT) == 0) &&
+	        ((ctxt->options & XML_PARSE_DTDVALID) == 0) &&
+	        ((ctxt->options & XML_PARSE_DTDLOAD) == 0) &&
+	        ((ctxt->options & XML_PARSE_DTDATTR) == 0) &&
+	        (ctxt->replaceEntities == 0) &&
+	        (ctxt->validate == 0))
+	        return;
 	    /*
 	     * TODO !!!
 	     * handle the extra spaces added before and after
Index: external/libxml2/xpointer.c
===================================================================
--- external/libxml2/xpointer.c	(revision 175234)
+++ external/libxml2/xpointer.c	(revision 175235)
@@ -320,6 +320,45 @@
 }
 
 /**
+ * xmlXPtrNewRangeInternal:
+ * @start:  the starting node
+ * @startindex:  the start index
+ * @end:  the ending point
+ * @endindex:  the ending index
+ *
+ * Internal function to create a new xmlXPathObjectPtr of type range
+ *
+ * Returns the newly created object.
+ */
+static xmlXPathObjectPtr
+xmlXPtrNewRangeInternal(xmlNodePtr start, int startindex,
+                        xmlNodePtr end, int endindex) {
+    xmlXPathObjectPtr ret;
+
+    /*
+     * Namespace nodes must be copied (see xmlXPathNodeSetDupNs).
+     * Disallow them for now.
+     */
+    if ((start != NULL) && (start->type == XML_NAMESPACE_DECL))
+	return(NULL);
+    if ((end != NULL) && (end->type == XML_NAMESPACE_DECL))
+	return(NULL);
+
+    ret = (xmlXPathObjectPtr) xmlMalloc(sizeof(xmlXPathObject));
+    if (ret == NULL) {
+        xmlXPtrErrMemory("allocating range");
+	return(NULL);
+    }
+    memset(ret, 0, sizeof(xmlXPathObject));
+    ret->type = XPATH_RANGE;
+    ret->user = start;
+    ret->index = startindex;
+    ret->user2 = end;
+    ret->index2 = endindex;
+    return(ret);
+}
+
+/**
  * xmlXPtrNewRange:
  * @start:  the starting node
  * @startindex:  the start index
@@ -344,17 +383,7 @@
     if (endindex < 0)
 	return(NULL);
 
-    ret = (xmlXPathObjectPtr) xmlMalloc(sizeof(xmlXPathObject));
-    if (ret == NULL) {
-        xmlXPtrErrMemory("allocating range");
-	return(NULL);
-    }
-    memset(ret, 0 , (size_t) sizeof(xmlXPathObject));
-    ret->type = XPATH_RANGE;
-    ret->user = start;
-    ret->index = startindex;
-    ret->user2 = end;
-    ret->index2 = endindex;
+    ret = xmlXPtrNewRangeInternal(start, startindex, end, endindex);
     xmlXPtrRangeCheckOrder(ret);
     return(ret);
 }
@@ -381,17 +410,8 @@
     if (end->type != XPATH_POINT)
 	return(NULL);
 
-    ret = (xmlXPathObjectPtr) xmlMalloc(sizeof(xmlXPathObject));
-    if (ret == NULL) {
-        xmlXPtrErrMemory("allocating range");
-	return(NULL);
-    }
-    memset(ret, 0 , (size_t) sizeof(xmlXPathObject));
-    ret->type = XPATH_RANGE;
-    ret->user = start->user;
-    ret->index = start->index;
-    ret->user2 = end->user;
-    ret->index2 = end->index;
+    ret = = xmlXPtrNewRangeInternal(start->user, start->index, end->user,
+     end->index);
     xmlXPtrRangeCheckOrder(ret);
     return(ret);
 }
@@ -416,17 +436,7 @@
     if (start->type != XPATH_POINT)
 	return(NULL);
 
-    ret = (xmlXPathObjectPtr) xmlMalloc(sizeof(xmlXPathObject));
-    if (ret == NULL) {
-        xmlXPtrErrMemory("allocating range");
-	return(NULL);
-    }
-    memset(ret, 0 , (size_t) sizeof(xmlXPathObject));
-    ret->type = XPATH_RANGE;
-    ret->user = start->user;
-    ret->index = start->index;
-    ret->user2 = end;
-    ret->index2 = -1;
+    ret = xmlXPtrNewRangeInternal(start->user, start->index, end, -1);
     xmlXPtrRangeCheckOrder(ret);
     return(ret);
 }
@@ -453,17 +463,7 @@
     if (end->type != XPATH_POINT)
 	return(NULL);
 
-    ret = (xmlXPathObjectPtr) xmlMalloc(sizeof(xmlXPathObject));
-    if (ret == NULL) {
-        xmlXPtrErrMemory("allocating range");
-	return(NULL);
-    }
-    memset(ret, 0 , (size_t) sizeof(xmlXPathObject));
-    ret->type = XPATH_RANGE;
-    ret->user = start;
-    ret->index = -1;
-    ret->user2 = end->user;
-    ret->index2 = end->index;
+    ret = xmlXPtrNewRangeInternal(start, -1, end->user, end->index);
     xmlXPtrRangeCheckOrder(ret);
     return(ret);
 }
@@ -486,17 +486,7 @@
     if (end == NULL)
 	return(NULL);
 
-    ret = (xmlXPathObjectPtr) xmlMalloc(sizeof(xmlXPathObject));
-    if (ret == NULL) {
-        xmlXPtrErrMemory("allocating range");
-	return(NULL);
-    }
-    memset(ret, 0 , (size_t) sizeof(xmlXPathObject));
-    ret->type = XPATH_RANGE;
-    ret->user = start;
-    ret->index = -1;
-    ret->user2 = end;
-    ret->index2 = -1;
+    ret = xmlXPtrNewRangeInternal(start, -1, end, -1);
     xmlXPtrRangeCheckOrder(ret);
     return(ret);
 }
@@ -516,17 +506,7 @@
     if (start == NULL)
 	return(NULL);
 
-    ret = (xmlXPathObjectPtr) xmlMalloc(sizeof(xmlXPathObject));
-    if (ret == NULL) {
-        xmlXPtrErrMemory("allocating range");
-	return(NULL);
-    }
-    memset(ret, 0 , (size_t) sizeof(xmlXPathObject));
-    ret->type = XPATH_RANGE;
-    ret->user = start;
-    ret->index = -1;
-    ret->user2 = NULL;
-    ret->index2 = -1;
+    ret = xmlXPtrNewRangeInternal(start, -1, NULL, -1);
     return(ret);
 }
 
@@ -541,6 +521,8 @@
  */
 xmlXPathObjectPtr
 xmlXPtrNewRangeNodeObject(xmlNodePtr start, xmlXPathObjectPtr end) {
+	xmlNodePtr endNode;
+    int endIndex;
     xmlXPathObjectPtr ret;
 
     if (start == NULL)
@@ -549,7 +531,12 @@
 	return(NULL);
     switch (end->type) {
 	case XPATH_POINT:
+		endNode = end->user;
+	    endIndex = end->index;
+	    break;
 	case XPATH_RANGE:
+		endNode = end->user2;
+	    endIndex = end->index2;
 	    break;
 	case XPATH_NODESET:
 	    /*
@@ -557,6 +544,8 @@
 	     */
 	    if (end->nodesetval->nodeNr <= 0)
 		return(NULL);
+		endNode = end->nodesetval->nodeTab[end->nodesetval->nodeNr - 1];
+	    endIndex = -1;
 	    break;
 	default:
 	    /* TODO */
@@ -563,33 +552,7 @@
 	    return(NULL);
     }
 
-    ret = (xmlXPathObjectPtr) xmlMalloc(sizeof(xmlXPathObject));
-    if (ret == NULL) {
-        xmlXPtrErrMemory("allocating range");
-	return(NULL);
-    }
-    memset(ret, 0 , (size_t) sizeof(xmlXPathObject));
-    ret->type = XPATH_RANGE;
-    ret->user = start;
-    ret->index = -1;
-    switch (end->type) {
-	case XPATH_POINT:
-	    ret->user2 = end->user;
-	    ret->index2 = end->index;
-	    break;
-	case XPATH_RANGE:
-	    ret->user2 = end->user2;
-	    ret->index2 = end->index2;
-	    break;
-	case XPATH_NODESET: {
-	    ret->user2 = end->nodesetval->nodeTab[end->nodesetval->nodeNr - 1];
-	    ret->index2 = -1;
-	    break;
-	}
-	default:
-	    STRANGE
-	    return(NULL);
-    }
+    ret = xmlXPtrNewRangeInternal(start, -1, endNode, endIndex);
     xmlXPtrRangeCheckOrder(ret);
     return(ret);
 }
@@ -1332,8 +1295,6 @@
     ret->here = here;
     ret->origin = origin;
 
-    xmlXPathRegisterFunc(ret, (xmlChar *)"range-to",
-	                 xmlXPtrRangeToFunction);
     xmlXPathRegisterFunc(ret, (xmlChar *)"range",
 	                 xmlXPtrRangeFunction);
     xmlXPathRegisterFunc(ret, (xmlChar *)"range-inside",
@@ -2245,74 +2206,11 @@
  * Implement the range-to() XPointer function
  */
 void
-xmlXPtrRangeToFunction(xmlXPathParserContextPtr ctxt, int nargs) {
-    xmlXPathObjectPtr range;
-    const xmlChar *cur;
-    xmlXPathObjectPtr res, obj;
-    xmlXPathObjectPtr tmp;
-    xmlLocationSetPtr newset = NULL;
-    xmlNodeSetPtr oldset;
-    int i;
-
-    if (ctxt == NULL) return;
-    CHECK_ARITY(1);
-    /*
-     * Save the expression pointer since we will have to evaluate
-     * it multiple times. Initialize the new set.
-     */
-    CHECK_TYPE(XPATH_NODESET);
-    obj = valuePop(ctxt);
-    oldset = obj->nodesetval;
-    ctxt->context->node = NULL;
-
-    cur = ctxt->cur;
-    newset = xmlXPtrLocationSetCreate(NULL);
-
-    for (i = 0; i < oldset->nodeNr; i++) {
-	ctxt->cur = cur;
-
-	/*
-	 * Run the evaluation with a node list made of a single item
-	 * in the nodeset.
-	 */
-	ctxt->context->node = oldset->nodeTab[i];
-	tmp = xmlXPathNewNodeSet(ctxt->context->node);
-	valuePush(ctxt, tmp);
-
-	xmlXPathEvalExpr(ctxt);
-	CHECK_ERROR;
-
-	/*
-	 * The result of the evaluation need to be tested to
-	 * decided whether the filter succeeded or not
-	 */
-	res = valuePop(ctxt);
-	range = xmlXPtrNewRangeNodeObject(oldset->nodeTab[i], res);
-	if (range != NULL) {
-	    xmlXPtrLocationSetAdd(newset, range);
-	}
-
-	/*
-	 * Cleanup
-	 */
-	if (res != NULL)
-	    xmlXPathFreeObject(res);
-	if (ctxt->value == tmp) {
-	    res = valuePop(ctxt);
-	    xmlXPathFreeObject(res);
-	}
-
-	ctxt->context->node = NULL;
-    }
-
-    /*
-     * The result is used as the new evaluation set.
-     */
-    xmlXPathFreeObject(obj);
-    ctxt->context->node = NULL;
-    ctxt->context->contextSize = -1;
-    ctxt->context->proximityPosition = -1;
-    valuePush(ctxt, xmlXPtrWrapLocationSet(newset));
+xmlXPtrRangeToFunction(xmlXPathParserContextPtr ctxt, 
+						int nargs ATTRIBUTE_UNUSED) {
+   
+   XP_ERROR(XPATH_EXPR_ERROR);
+ 
 }
 
 /**
Index: external/libxml2/test/XPath/xptr/vidbase
===================================================================
--- external/libxml2/test/XPath/xptr/vidbase	(revision 175234)
+++ external/libxml2/test/XPath/xptr/vidbase	(revision 175235)
@@ -1,2 +1,3 @@
 xpointer(id('chapter1')/p)
 xpointer(id('chapter1')/p[1]/range-to(following-sibling::p[2]))
+xpointer(range-to(id('chapter2')))
\ No newline at end of file
Index: external/libxml2/valid.c
===================================================================
--- external/libxml2/valid.c	(revision 175234)
+++ external/libxml2/valid.c	(revision 175235)
@@ -4623,13 +4623,13 @@
 
     /* Validity Constraint: ID uniqueness */
     if (attrDecl->atype == XML_ATTRIBUTE_ID) {
-        if (xmlAddID(ctxt, doc, value, (xmlAttrPtr) ns) == NULL)
+        if (xmlAddID(ctxt, doc, value, (xmlAttrPtr) attrDecl) == NULL)
 	    ret = 0;
     }
 
     if ((attrDecl->atype == XML_ATTRIBUTE_IDREF) ||
 	(attrDecl->atype == XML_ATTRIBUTE_IDREFS)) {
-        if (xmlAddRef(ctxt, doc, value, (xmlAttrPtr) ns) == NULL)
+        if (xmlAddRef(ctxt, doc, value, (xmlAttrPtr) attrDecl) == NULL)
 	    ret = 0;
     }
 
Index: external/libavc/decoder/ih264d_api.c
===================================================================
--- external/libavc/decoder/ih264d_api.c	(revision 175234)
+++ external/libavc/decoder/ih264d_api.c	(revision 175235)
@@ -2126,8 +2126,9 @@
         WORD32 prev_slice_err;
         pocstruct_t temp_poc;
         WORD32 ret1;
-
-        num_mb_skipped = (ps_dec->u2_frm_ht_in_mbs * ps_dec->u2_frm_wd_in_mbs)
+        WORD32 ht_in_mbs;
+        ht_in_mbs = ps_dec->u2_pic_ht >> (4 + ps_dec->ps_cur_slice->u1_field_pic_flag);
+        num_mb_skipped = (ht_in_mbs * ps_dec->u2_frm_wd_in_mbs)
                             - ps_dec->u2_total_mbs_coded;
 
         if(ps_dec->u4_first_slice_in_pic && (ps_dec->u4_pic_buf_got == 0))
Index: external/libhevc/decoder/ihevcd_cabac.c
===================================================================
--- external/libhevc/decoder/ihevcd_cabac.c	(revision 175234)
+++ external/libhevc/decoder/ihevcd_cabac.c	(revision 175235)
@@ -163,6 +163,10 @@
            pu1_init_ctxt,
            IHEVC_CAB_CTXT_END);
     DEBUG_RANGE_OFST("init", ps_cabac->u4_range, ps_cabac->u4_ofst);
+    if(ps_cabac->u4_ofst >= ps_cabac->u4_range)
+    {
+        return ((IHEVCD_ERROR_T)IHEVCD_FAIL);
+    }
     return ((IHEVCD_ERROR_T)IHEVCD_SUCCESS);
 }
 
Index: external/libhevc/decoder/ihevcd_ref_list.c
===================================================================
--- external/libhevc/decoder/ihevcd_ref_list.c	(revision 175234)
+++ external/libhevc/decoder/ihevcd_ref_list.c	(revision 175235)
@@ -92,7 +92,7 @@
 
 WORD32 ihevcd_ref_list(codec_t *ps_codec, pps_t *ps_pps, sps_t *ps_sps, slice_header_t *ps_slice_hdr)
 {
-    WORD32 i;
+    WORD32 i, j;
     WORD32 st_rps_idx;
     WORD32 num_neg_pics, num_pos_pics;
     WORD8 *pi1_used;
@@ -503,11 +503,11 @@
 
             /* Find buffer id of the MV bank corresponding to the buffer being freed (Buffer with POC of u4_abs_poc) */
             ps_mv_buf = (mv_buf_t *)ps_codec->ps_mv_buf;
-            for(i = 0; i < BUF_MGR_MAX_CNT; i++)
+            for(j = 0; j < ps_codec->i4_max_dpb_size; j++)
             {
                 if(ps_mv_buf && ps_mv_buf->i4_abs_poc == ps_pic_buf->i4_abs_poc)
                 {
-                    ihevc_buf_mgr_release((buf_mgr_t *)ps_codec->pv_mv_buf_mgr, i, BUF_MGR_REF);
+                    ihevc_buf_mgr_release((buf_mgr_t *)ps_codec->pv_mv_buf_mgr, j, BUF_MGR_REF);
                     break;
                 }
                 ps_mv_buf++;
Index: external/libhevc/decoder/ihevcd_structs.h
===================================================================
--- external/libhevc/decoder/ihevcd_structs.h	(revision 175234)
+++ external/libhevc/decoder/ihevcd_structs.h	(revision 175235)
@@ -1929,6 +1929,7 @@
      */
     void *ps_mv_buf;
 
+    WORD32 i4_max_dpb_size;
     /**
      * Base address for Motion Vector bank buffer
      */
Index: external/libhevc/decoder/ihevcd_parse_slice.c
===================================================================
--- external/libhevc/decoder/ihevcd_parse_slice.c	(revision 175234)
+++ external/libhevc/decoder/ihevcd_parse_slice.c	(revision 175235)
@@ -2370,11 +2370,17 @@
     }
     else if((0 == ps_pps->i1_entropy_coding_sync_enabled_flag) || (ps_pps->i1_entropy_coding_sync_enabled_flag && (0 != ps_codec->s_parse.i4_ctb_x)))
     {
-        ihevcd_cabac_init(&ps_codec->s_parse.s_cabac,
+        ret = ihevcd_cabac_init(&ps_codec->s_parse.s_cabac,
                           &ps_codec->s_parse.s_bitstrm,
                           slice_qp,
                           cabac_init_idc,
                           &gau1_ihevc_cab_ctxts[cabac_init_idc][slice_qp][0]);
+        if(ret != (IHEVCD_ERROR_T)IHEVCD_SUCCESS)
+        {
+            ps_codec->i4_slice_error = 1;
+            end_of_slice_flag = 1;
+            ret = (IHEVCD_ERROR_T)IHEVCD_SUCCESS;
+        }
     }
 
 
@@ -2458,11 +2464,17 @@
             /* Cabac init is done unconditionally at the start of the tile irrespective
              * of whether it is a dependent or an independent slice */
             {
-                ihevcd_cabac_init(&ps_codec->s_parse.s_cabac,
+                ret = ihevcd_cabac_init(&ps_codec->s_parse.s_cabac,
                                   &ps_codec->s_parse.s_bitstrm,
                                   slice_qp,
                                   cabac_init_idc,
                                   &gau1_ihevc_cab_ctxts[cabac_init_idc][slice_qp][0]);
+                if(ret != (IHEVCD_ERROR_T)IHEVCD_SUCCESS)
+                {
+                    ps_codec->i4_slice_error = 1;
+                    end_of_slice_flag = 1;
+                    ret = (IHEVCD_ERROR_T)IHEVCD_SUCCESS;
+                }
 
             }
         }
@@ -2528,22 +2540,34 @@
                 if(default_ctxt)
                 {
                     //memcpy(&ps_codec->s_parse.s_cabac.au1_ctxt_models, &gau1_ihevc_cab_ctxts[cabac_init_idc][slice_qp][0], size);
-                    ihevcd_cabac_init(&ps_codec->s_parse.s_cabac,
+                    ret = ihevcd_cabac_init(&ps_codec->s_parse.s_cabac,
                                       &ps_codec->s_parse.s_bitstrm,
                                       slice_qp,
                                       cabac_init_idc,
                                       &gau1_ihevc_cab_ctxts[cabac_init_idc][slice_qp][0]);
 
+                    if(ret != (IHEVCD_ERROR_T)IHEVCD_SUCCESS)
+                    {
+                        ps_codec->i4_slice_error = 1;
+                        end_of_slice_flag = 1;
+                        ret = (IHEVCD_ERROR_T)IHEVCD_SUCCESS;
+                    }
                 }
                 else
                 {
                     //memcpy(&ps_codec->s_parse.s_cabac.au1_ctxt_models, &ps_codec->s_parse.s_cabac.au1_ctxt_models_sync, size);
-                    ihevcd_cabac_init(&ps_codec->s_parse.s_cabac,
+                    ret = ihevcd_cabac_init(&ps_codec->s_parse.s_cabac,
                                       &ps_codec->s_parse.s_bitstrm,
                                       slice_qp,
                                       cabac_init_idc,
                                       (const UWORD8 *)&ps_codec->s_parse.s_cabac.au1_ctxt_models_sync);
 
+                    if(ret != (IHEVCD_ERROR_T)IHEVCD_SUCCESS)
+                    {
+                        ps_codec->i4_slice_error = 1;
+                        end_of_slice_flag = 1;
+                        ret = (IHEVCD_ERROR_T)IHEVCD_SUCCESS;
+                    }
                 }
             }
         }
@@ -3260,6 +3284,7 @@
             break;
     } while(!end_of_slice_flag);
 
+    ps_codec->i4_slice_error = 0;
     /* Increment the slice index for parsing next slice */
     if(0 == end_of_pic)
     {
Index: external/libhevc/decoder/ihevcd_parse_slice_header.c
===================================================================
--- external/libhevc/decoder/ihevcd_parse_slice_header.c	(revision 175234)
+++ external/libhevc/decoder/ihevcd_parse_slice_header.c	(revision 175235)
@@ -219,7 +219,7 @@
 {
     IHEVCD_ERROR_T ret = (IHEVCD_ERROR_T)IHEVCD_SUCCESS;
     WORD32 value;
-    WORD32 i;
+    WORD32 i, j;
     WORD32 sps_id;
 
     pps_t *ps_pps;
@@ -729,11 +729,15 @@
             {
                 if(ps_codec->i4_pic_present)
                 {
+                    slice_header_t *ps_slice_hdr_next;
                     ps_codec->i4_slice_error = 1;
                     ps_codec->s_parse.i4_cur_slice_idx--;
                     if(ps_codec->s_parse.i4_cur_slice_idx < 0)
                         ps_codec->s_parse.i4_cur_slice_idx = 0;
 
+                    ps_slice_hdr_next = ps_codec->s_parse.ps_slice_hdr_base + ((ps_codec->s_parse.i4_cur_slice_idx + 1) & (MAX_SLICE_HDR_CNT - 1));
+                    ps_slice_hdr_next->i2_ctb_x = slice_address % ps_sps->i2_pic_wd_in_ctb;
+                    ps_slice_hdr_next->i2_ctb_y = slice_address / ps_sps->i2_pic_wd_in_ctb;
                     return ret;
                 }
                 else
@@ -880,11 +884,11 @@
                     ihevc_dpb_mgr_del_ref((dpb_mgr_t *)ps_codec->pv_dpb_mgr, (buf_mgr_t *)ps_codec->pv_pic_buf_mgr, ps_pic_buf->i4_abs_poc);
                     /* Find buffer id of the MV bank corresponding to the buffer being freed (Buffer with POC of u4_abs_poc) */
                     ps_mv_buf = (mv_buf_t *)ps_codec->ps_mv_buf;
-                    for(i = 0; i < BUF_MGR_MAX_CNT; i++)
+                    for(j = 0; j < ps_codec->i4_max_dpb_size; j++)
                     {
                         if(ps_mv_buf && ps_mv_buf->i4_abs_poc == ps_pic_buf->i4_abs_poc)
                         {
-                            ihevc_buf_mgr_release((buf_mgr_t *)ps_codec->pv_mv_buf_mgr, i, BUF_MGR_REF);
+                            ihevc_buf_mgr_release((buf_mgr_t *)ps_codec->pv_mv_buf_mgr, j, BUF_MGR_REF);
                             break;
                         }
                         ps_mv_buf++;
Index: external/libhevc/decoder/ihevcd_utils.c
===================================================================
--- external/libhevc/decoder/ihevcd_utils.c	(revision 175234)
+++ external/libhevc/decoder/ihevcd_utils.c	(revision 175235)
@@ -598,6 +598,7 @@
      */
     max_dpb_size++;
 
+    ps_codec->i4_max_dpb_size = max_dpb_size;
     pu1_buf = (UWORD8 *)ps_codec->pv_mv_bank_buf_base;
 
     ps_mv_buf = (mv_buf_t *)pu1_buf;
Index: external/libhevc/decoder/ihevcd_parse_headers.c
===================================================================
--- external/libhevc/decoder/ihevcd_parse_headers.c	(revision 175234)
+++ external/libhevc/decoder/ihevcd_parse_headers.c	(revision 175235)
@@ -1222,6 +1222,11 @@
 
 
     ps_sps = (ps_codec->s_parse.ps_sps_base + MAX_SPS_CNT - 1);
+    {
+        WORD16 *pi2_scaling_mat = ps_sps->pi2_scaling_mat;
+        memset(ps_sps, 0, sizeof(sps_t));
+        ps_sps->pi2_scaling_mat = pi2_scaling_mat;
+    }
     ps_sps->i1_sps_id = sps_id;
     ps_sps->i1_vps_id = vps_id;
     ps_sps->i1_sps_max_sub_layers = sps_max_sub_layers;
@@ -1749,6 +1754,10 @@
     ps_pps->i1_loop_filter_across_tiles_enabled_flag = 0;
     if(ps_pps->i1_tiles_enabled_flag)
     {
+        WORD32 wd = ALIGN64(ps_codec->i4_wd);
+        WORD32 ht = ALIGN64(ps_codec->i4_ht);
+        WORD32 max_tile_cols = (wd + MIN_TILE_WD - 1) / MIN_TILE_WD;
+        WORD32 max_tile_rows = (ht + MIN_TILE_HT - 1) / MIN_TILE_HT;
         UEV_PARSE("num_tile_columns_minus1", value, ps_bitstrm);
         ps_pps->i1_num_tile_columns = value + 1;
 
@@ -1756,9 +1765,9 @@
         ps_pps->i1_num_tile_rows = value + 1;
 
         if((ps_pps->i1_num_tile_columns < 1) ||
-                        (ps_pps->i1_num_tile_columns > ps_sps->i2_pic_wd_in_ctb) ||
+                        (ps_pps->i1_num_tile_columns > max_tile_cols) ||
                         (ps_pps->i1_num_tile_rows < 1) ||
-                        (ps_pps->i1_num_tile_rows > ps_sps->i2_pic_ht_in_ctb))
+                        (ps_pps->i1_num_tile_rows > max_tile_rows))
             return IHEVCD_INVALID_HEADER;
 
         BITS_PARSE("uniform_spacing_flag", value, ps_bitstrm, 1);
Index: external/libvpx/config/arm/vpx_config.asm
===================================================================
--- external/libvpx/config/arm/vpx_config.asm	(revision 175234)
+++ external/libvpx/config/arm/vpx_config.asm	(revision 175235)
@@ -82,7 +82,7 @@
 .equ CONFIG_COEFFICIENT_RANGE_CHECKING ,  0
 .equ CONFIG_VP9_HIGHBITDEPTH ,  0
 .equ CONFIG_EXPERIMENTAL ,  0
-.equ CONFIG_SIZE_LIMIT ,  0
+.equ CONFIG_SIZE_LIMIT ,  1
 .equ CONFIG_SPATIAL_SVC ,  0
 .equ CONFIG_FP_MB_STATS ,  0
 .equ CONFIG_EMULATE_HARDWARE ,  0
Index: external/libvpx/config/arm/vpx_config.c
===================================================================
--- external/libvpx/config/arm/vpx_config.c	(revision 175234)
+++ external/libvpx/config/arm/vpx_config.c	(revision 175235)
@@ -6,5 +6,5 @@
 /* in the file PATENTS.  All contributing project authors may */
 /* be found in the AUTHORS file in the root of the source tree. */
 #include "vpx/vpx_codec.h"
-static const char* const cfg = "--target=armv6-linux-gcc --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect";
+static const char* const cfg = "--target=armv6-linux-gcc --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect --disable-install-docs --size-limit=4096x3072";
 const char *vpx_codec_build_config(void) {return cfg;}
Index: external/libvpx/config/arm/vpx_config.h
===================================================================
--- external/libvpx/config/arm/vpx_config.h	(revision 175234)
+++ external/libvpx/config/arm/vpx_config.h	(revision 175235)
@@ -91,9 +91,11 @@
 #define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 #define CONFIG_VP9_HIGHBITDEPTH 0
 #define CONFIG_EXPERIMENTAL 0
-#define CONFIG_SIZE_LIMIT 0
+#define CONFIG_SIZE_LIMIT 1
 #define CONFIG_SPATIAL_SVC 0
 #define CONFIG_FP_MB_STATS 0
 #define CONFIG_EMULATE_HARDWARE 0
 #define CONFIG_MISC_FIXES 0
+#define DECODE_WIDTH_LIMIT 4096
+#define DECODE_HEIGHT_LIMIT 3072
 #endif /* VPX_CONFIG_H */
Index: external/libvpx/config/mips64/vpx_config.c
===================================================================
--- external/libvpx/config/mips64/vpx_config.c	(revision 175234)
+++ external/libvpx/config/mips64/vpx_config.c	(revision 175235)
@@ -6,5 +6,5 @@
 /* in the file PATENTS.  All contributing project authors may */
 /* be found in the AUTHORS file in the root of the source tree. */
 #include "vpx/vpx_codec.h"
-static const char* const cfg = "--target=mips64-linux-gcc --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect";
+static const char* const cfg = "--target=mips64-linux-gcc --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect --disable-install-docs --size-limit=4096x3072";
 const char *vpx_codec_build_config(void) {return cfg;}
Index: external/libvpx/config/mips64/vpx_config.h
===================================================================
--- external/libvpx/config/mips64/vpx_config.h	(revision 175234)
+++ external/libvpx/config/mips64/vpx_config.h	(revision 175235)
@@ -91,9 +91,11 @@
 #define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 #define CONFIG_VP9_HIGHBITDEPTH 0
 #define CONFIG_EXPERIMENTAL 0
-#define CONFIG_SIZE_LIMIT 0
+#define CONFIG_SIZE_LIMIT 1
 #define CONFIG_SPATIAL_SVC 0
 #define CONFIG_FP_MB_STATS 0
 #define CONFIG_EMULATE_HARDWARE 0
 #define CONFIG_MISC_FIXES 0
+#define DECODE_WIDTH_LIMIT 4096
+#define DECODE_HEIGHT_LIMIT 3072
 #endif /* VPX_CONFIG_H */
Index: external/libvpx/config/mips32-dspr2/vpx_config.c
===================================================================
--- external/libvpx/config/mips32-dspr2/vpx_config.c	(revision 175234)
+++ external/libvpx/config/mips32-dspr2/vpx_config.c	(revision 175235)
@@ -6,5 +6,5 @@
 /* in the file PATENTS.  All contributing project authors may */
 /* be found in the AUTHORS file in the root of the source tree. */
 #include "vpx/vpx_codec.h"
-static const char* const cfg = "--target=mips32-linux-gcc --enable-dspr2 --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect";
+static const char* const cfg = "--target=mips32-linux-gcc --enable-dspr2 --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect --disable-install-docs --size-limit=4096x3072";
 const char *vpx_codec_build_config(void) {return cfg;}
Index: external/libvpx/config/mips32-dspr2/vpx_config.h
===================================================================
--- external/libvpx/config/mips32-dspr2/vpx_config.h	(revision 175234)
+++ external/libvpx/config/mips32-dspr2/vpx_config.h	(revision 175235)
@@ -91,9 +91,11 @@
 #define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 #define CONFIG_VP9_HIGHBITDEPTH 0
 #define CONFIG_EXPERIMENTAL 0
-#define CONFIG_SIZE_LIMIT 0
+#define CONFIG_SIZE_LIMIT 1
 #define CONFIG_SPATIAL_SVC 0
 #define CONFIG_FP_MB_STATS 0
 #define CONFIG_EMULATE_HARDWARE 0
 #define CONFIG_MISC_FIXES 0
+#define DECODE_WIDTH_LIMIT 4096
+#define DECODE_HEIGHT_LIMIT 3072
 #endif /* VPX_CONFIG_H */
Index: external/libvpx/config/x86/vpx_config.asm
===================================================================
--- external/libvpx/config/x86/vpx_config.asm	(revision 175234)
+++ external/libvpx/config/x86/vpx_config.asm	(revision 175235)
@@ -79,7 +79,7 @@
 %define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 %define CONFIG_VP9_HIGHBITDEPTH 0
 %define CONFIG_EXPERIMENTAL 0
-%define CONFIG_SIZE_LIMIT 0
+%define CONFIG_SIZE_LIMIT 1
 %define CONFIG_SPATIAL_SVC 0
 %define CONFIG_FP_MB_STATS 0
 %define CONFIG_EMULATE_HARDWARE 0
Index: external/libvpx/config/x86/vpx_config.c
===================================================================
--- external/libvpx/config/x86/vpx_config.c	(revision 175234)
+++ external/libvpx/config/x86/vpx_config.c	(revision 175235)
@@ -6,5 +6,5 @@
 /* in the file PATENTS.  All contributing project authors may */
 /* be found in the AUTHORS file in the root of the source tree. */
 #include "vpx/vpx_codec.h"
-static const char* const cfg = "--target=x86-linux-gcc --disable-sse4_1 --disable-avx --disable-avx2 --as=yasm --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect";
+static const char* const cfg = "--target=x86-linux-gcc --disable-sse4_1 --disable-avx --disable-avx2 --as=yasm --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect --disable-install-docs --size-limit=4096x3072";
 const char *vpx_codec_build_config(void) {return cfg;}
Index: external/libvpx/config/x86/vpx_config.h
===================================================================
--- external/libvpx/config/x86/vpx_config.h	(revision 175234)
+++ external/libvpx/config/x86/vpx_config.h	(revision 175235)
@@ -91,9 +91,11 @@
 #define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 #define CONFIG_VP9_HIGHBITDEPTH 0
 #define CONFIG_EXPERIMENTAL 0
-#define CONFIG_SIZE_LIMIT 0
+#define CONFIG_SIZE_LIMIT 1
 #define CONFIG_SPATIAL_SVC 0
 #define CONFIG_FP_MB_STATS 0
 #define CONFIG_EMULATE_HARDWARE 0
 #define CONFIG_MISC_FIXES 0
+#define DECODE_WIDTH_LIMIT 4096
+#define DECODE_HEIGHT_LIMIT 3072
 #endif /* VPX_CONFIG_H */
Index: external/libvpx/config/arm64/vpx_config.c
===================================================================
--- external/libvpx/config/arm64/vpx_config.c	(revision 175234)
+++ external/libvpx/config/arm64/vpx_config.c	(revision 175235)
@@ -6,5 +6,5 @@
 /* in the file PATENTS.  All contributing project authors may */
 /* be found in the AUTHORS file in the root of the source tree. */
 #include "vpx/vpx_codec.h"
-static const char* const cfg = "--force-target=armv8-linux-gcc --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect";
+static const char* const cfg = "--force-target=armv8-linux-gcc --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect --disable-install-docs --size-limit=4096x3072";
 const char *vpx_codec_build_config(void) {return cfg;}
Index: external/libvpx/config/arm64/vpx_config.h
===================================================================
--- external/libvpx/config/arm64/vpx_config.h	(revision 175234)
+++ external/libvpx/config/arm64/vpx_config.h	(revision 175235)
@@ -91,9 +91,11 @@
 #define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 #define CONFIG_VP9_HIGHBITDEPTH 0
 #define CONFIG_EXPERIMENTAL 0
-#define CONFIG_SIZE_LIMIT 0
+#define CONFIG_SIZE_LIMIT 1
 #define CONFIG_SPATIAL_SVC 0
 #define CONFIG_FP_MB_STATS 0
 #define CONFIG_EMULATE_HARDWARE 0
 #define CONFIG_MISC_FIXES 0
+#define DECODE_WIDTH_LIMIT 4096
+#define DECODE_HEIGHT_LIMIT 3072
 #endif /* VPX_CONFIG_H */
Index: external/libvpx/config/arm64/vpx_config.asm
===================================================================
--- external/libvpx/config/arm64/vpx_config.asm	(revision 175234)
+++ external/libvpx/config/arm64/vpx_config.asm	(revision 175235)
@@ -82,7 +82,7 @@
 .equ CONFIG_COEFFICIENT_RANGE_CHECKING ,  0
 .equ CONFIG_VP9_HIGHBITDEPTH ,  0
 .equ CONFIG_EXPERIMENTAL ,  0
-.equ CONFIG_SIZE_LIMIT ,  0
+.equ CONFIG_SIZE_LIMIT ,  1
 .equ CONFIG_SPATIAL_SVC ,  0
 .equ CONFIG_FP_MB_STATS ,  0
 .equ CONFIG_EMULATE_HARDWARE ,  0
Index: external/libvpx/config/arm-neon/vpx_config.c
===================================================================
--- external/libvpx/config/arm-neon/vpx_config.c	(revision 175234)
+++ external/libvpx/config/arm-neon/vpx_config.c	(revision 175235)
@@ -6,5 +6,5 @@
 /* in the file PATENTS.  All contributing project authors may */
 /* be found in the AUTHORS file in the root of the source tree. */
 #include "vpx/vpx_codec.h"
-static const char* const cfg = "--target=armv7-linux-gcc --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect";
+static const char* const cfg = "--target=armv7-linux-gcc --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect --disable-install-docs --size-limit=4096x3072";
 const char *vpx_codec_build_config(void) {return cfg;}
Index: external/libvpx/config/arm-neon/vpx_config.h
===================================================================
--- external/libvpx/config/arm-neon/vpx_config.h	(revision 175234)
+++ external/libvpx/config/arm-neon/vpx_config.h	(revision 175235)
@@ -91,9 +91,11 @@
 #define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 #define CONFIG_VP9_HIGHBITDEPTH 0
 #define CONFIG_EXPERIMENTAL 0
-#define CONFIG_SIZE_LIMIT 0
+#define CONFIG_SIZE_LIMIT 1
 #define CONFIG_SPATIAL_SVC 0
 #define CONFIG_FP_MB_STATS 0
 #define CONFIG_EMULATE_HARDWARE 0
 #define CONFIG_MISC_FIXES 0
+#define DECODE_WIDTH_LIMIT 4096
+#define DECODE_HEIGHT_LIMIT 3072
 #endif /* VPX_CONFIG_H */
Index: external/libvpx/config/arm-neon/vpx_config.asm
===================================================================
--- external/libvpx/config/arm-neon/vpx_config.asm	(revision 175234)
+++ external/libvpx/config/arm-neon/vpx_config.asm	(revision 175235)
@@ -82,7 +82,7 @@
 .equ CONFIG_COEFFICIENT_RANGE_CHECKING ,  0
 .equ CONFIG_VP9_HIGHBITDEPTH ,  0
 .equ CONFIG_EXPERIMENTAL ,  0
-.equ CONFIG_SIZE_LIMIT ,  0
+.equ CONFIG_SIZE_LIMIT ,  1
 .equ CONFIG_SPATIAL_SVC ,  0
 .equ CONFIG_FP_MB_STATS ,  0
 .equ CONFIG_EMULATE_HARDWARE ,  0
Index: external/libvpx/config/generic/vpx_config.asm
===================================================================
--- external/libvpx/config/generic/vpx_config.asm	(revision 175234)
+++ external/libvpx/config/generic/vpx_config.asm	(revision 175235)
@@ -82,7 +82,7 @@
 .equ CONFIG_COEFFICIENT_RANGE_CHECKING ,  0
 .equ CONFIG_VP9_HIGHBITDEPTH ,  0
 .equ CONFIG_EXPERIMENTAL ,  0
-.equ CONFIG_SIZE_LIMIT ,  0
+.equ CONFIG_SIZE_LIMIT ,  1
 .equ CONFIG_SPATIAL_SVC ,  0
 .equ CONFIG_FP_MB_STATS ,  0
 .equ CONFIG_EMULATE_HARDWARE ,  0
Index: external/libvpx/config/generic/vpx_config.c
===================================================================
--- external/libvpx/config/generic/vpx_config.c	(revision 175234)
+++ external/libvpx/config/generic/vpx_config.c	(revision 175235)
@@ -6,5 +6,5 @@
 /* in the file PATENTS.  All contributing project authors may */
 /* be found in the AUTHORS file in the root of the source tree. */
 #include "vpx/vpx_codec.h"
-static const char* const cfg = "--target=generic-gnu --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect";
+static const char* const cfg = "--target=generic-gnu --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect --disable-install-docs --size-limit=4096x3072";
 const char *vpx_codec_build_config(void) {return cfg;}
Index: external/libvpx/config/generic/vpx_config.h
===================================================================
--- external/libvpx/config/generic/vpx_config.h	(revision 175234)
+++ external/libvpx/config/generic/vpx_config.h	(revision 175235)
@@ -91,9 +91,11 @@
 #define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 #define CONFIG_VP9_HIGHBITDEPTH 0
 #define CONFIG_EXPERIMENTAL 0
-#define CONFIG_SIZE_LIMIT 0
+#define CONFIG_SIZE_LIMIT 1
 #define CONFIG_SPATIAL_SVC 0
 #define CONFIG_FP_MB_STATS 0
 #define CONFIG_EMULATE_HARDWARE 0
 #define CONFIG_MISC_FIXES 0
+#define DECODE_WIDTH_LIMIT 4096
+#define DECODE_HEIGHT_LIMIT 3072
 #endif /* VPX_CONFIG_H */
Index: external/libvpx/config/mips32/vpx_config.c
===================================================================
--- external/libvpx/config/mips32/vpx_config.c	(revision 175234)
+++ external/libvpx/config/mips32/vpx_config.c	(revision 175235)
@@ -6,5 +6,5 @@
 /* in the file PATENTS.  All contributing project authors may */
 /* be found in the AUTHORS file in the root of the source tree. */
 #include "vpx/vpx_codec.h"
-static const char* const cfg = "--target=mips32-linux-gcc --disable-dspr2 --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect";
+static const char* const cfg = "--target=mips32-linux-gcc --disable-dspr2 --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect --disable-install-docs --size-limit=4096x3072";
 const char *vpx_codec_build_config(void) {return cfg;}
Index: external/libvpx/config/mips32/vpx_config.h
===================================================================
--- external/libvpx/config/mips32/vpx_config.h	(revision 175234)
+++ external/libvpx/config/mips32/vpx_config.h	(revision 175235)
@@ -91,9 +91,11 @@
 #define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 #define CONFIG_VP9_HIGHBITDEPTH 0
 #define CONFIG_EXPERIMENTAL 0
-#define CONFIG_SIZE_LIMIT 0
+#define CONFIG_SIZE_LIMIT 1
 #define CONFIG_SPATIAL_SVC 0
 #define CONFIG_FP_MB_STATS 0
 #define CONFIG_EMULATE_HARDWARE 0
 #define CONFIG_MISC_FIXES 0
+#define DECODE_WIDTH_LIMIT 4096
+#define DECODE_HEIGHT_LIMIT 3072
 #endif /* VPX_CONFIG_H */
Index: external/libvpx/config/x86_64/vpx_config.asm
===================================================================
--- external/libvpx/config/x86_64/vpx_config.asm	(revision 175234)
+++ external/libvpx/config/x86_64/vpx_config.asm	(revision 175235)
@@ -79,7 +79,7 @@
 %define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 %define CONFIG_VP9_HIGHBITDEPTH 0
 %define CONFIG_EXPERIMENTAL 0
-%define CONFIG_SIZE_LIMIT 0
+%define CONFIG_SIZE_LIMIT 1
 %define CONFIG_SPATIAL_SVC 0
 %define CONFIG_FP_MB_STATS 0
 %define CONFIG_EMULATE_HARDWARE 0
Index: external/libvpx/config/x86_64/vpx_config.c
===================================================================
--- external/libvpx/config/x86_64/vpx_config.c	(revision 175234)
+++ external/libvpx/config/x86_64/vpx_config.c	(revision 175235)
@@ -6,5 +6,5 @@
 /* in the file PATENTS.  All contributing project authors may */
 /* be found in the AUTHORS file in the root of the source tree. */
 #include "vpx/vpx_codec.h"
-static const char* const cfg = "--target=x86_64-linux-gcc --disable-sse4_1 --disable-avx --disable-avx2 --as=yasm --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect";
+static const char* const cfg = "--target=x86_64-linux-gcc --disable-sse4_1 --disable-avx --disable-avx2 --as=yasm --enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect --disable-install-docs --size-limit=4096x3072";
 const char *vpx_codec_build_config(void) {return cfg;}
Index: external/libvpx/config/x86_64/vpx_config.h
===================================================================
--- external/libvpx/config/x86_64/vpx_config.h	(revision 175234)
+++ external/libvpx/config/x86_64/vpx_config.h	(revision 175235)
@@ -91,9 +91,11 @@
 #define CONFIG_COEFFICIENT_RANGE_CHECKING 0
 #define CONFIG_VP9_HIGHBITDEPTH 0
 #define CONFIG_EXPERIMENTAL 0
-#define CONFIG_SIZE_LIMIT 0
+#define CONFIG_SIZE_LIMIT 1
 #define CONFIG_SPATIAL_SVC 0
 #define CONFIG_FP_MB_STATS 0
 #define CONFIG_EMULATE_HARDWARE 0
 #define CONFIG_MISC_FIXES 0
+#define DECODE_WIDTH_LIMIT 4096
+#define DECODE_HEIGHT_LIMIT 3072
 #endif /* VPX_CONFIG_H */
Index: external/libvpx/generate_config.sh
===================================================================
--- external/libvpx/generate_config.sh	(revision 175234)
+++ external/libvpx/generate_config.sh	(revision 175235)
@@ -147,7 +147,7 @@
 cd $TEMP_DIR
 
 echo "Generate config files."
-all_platforms="--enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect"
+all_platforms="--enable-external-build --enable-realtime-only --enable-pic --disable-runtime-cpu-detect --disable-install-docs --size-limit=4096x3072"
 intel="--disable-sse4_1 --disable-avx --disable-avx2 --as=yasm"
 gen_config_files x86 "--target=x86-linux-gcc ${intel} ${all_platforms}"
 gen_config_files x86_64 "--target=x86_64-linux-gcc ${intel} ${all_platforms}"
Index: build/core/version_defaults.mk
===================================================================
--- build/core/version_defaults.mk	(revision 175234)
+++ build/core/version_defaults.mk	(revision 175235)
@@ -114,7 +114,7 @@
     #  It must be of the form "YYYY-MM-DD" on production devices.
     #  It must match one of the Android Security Patch Level strings of the Public Security Bulletins.
     #  If there is no $PLATFORM_SECURITY_PATCH set, keep it empty.
-      PLATFORM_SECURITY_PATCH := 2017-04-05
+      PLATFORM_SECURITY_PATCH := 2017-06-01
 
 endif
 
